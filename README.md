## Введение в NetPalm - Часть 2

![netpalm_logo](/images/logo.png)

### От автора оригинала:

Этот пост является продолжением [первой части](https://blog.wimwauters.com/networkprogrammability/2020-04-14_netpalm_introduction_part1/), в которой мы сосредоточились на получении информации с наших устройств с помощью **NetPalm**. Во второй части ([ссылка на оригинал](https://blog.wimwauters.com/networkprogrammability/2020-04-15_netpalm_introduction_part2/)) мы сосредоточимся на изменении/обновлении информации на устройстве. Опять же, для этого мы будем использовать API NetPalm, чередуя различные базовые инструменты.

*April 15, 2020*

*Всё что ниже - относительно вольный перевод статьи.*

### Пример 1: изменение конфигурации с Netmiko.

В этом примере наша цель - внести некие изменения на устройство, делать будем следующее:
1. Проверить существующие интерфейсы;
2. Внести изменения на интерфейс;
3. Опросить интерфейс и убедиться, что изменение применилось.

#### 1.1 Проверка существующих интерфейсов

Сначала посмотрим на существующие интерфейсы. Мы будем использовать метод, который мы узнали ранее.
![p2e111](/images/part2/p2e111.png)

Выполним задачу, получим обзор всех описаний интерфейсов.
![p2e112](/images/part2/p2e112.png)

#### 1.2 Вносим изменения на интерфейс

Далее мы изменим описание интерфейса GigabitEthernet3. Будем делать это с помощью метода setconfig, как описано [тут](https://documenter.getpostman.com/view/2391814/SzYbxcQx?version=latest#c6c4ca08-6ba5-4272-b9cb-457e1a986d57).

В атрибуте `config` мы передаём команды, которые хотим выполнить на нашем устройстве.
Обратите внимание, что Netmiko не требует `conf t`.

![p2e121](/images/part2/p2e121.png)

Ответ о выполненных нами изменениях. Обратите внимание, на `"status": "success"`.
![p2e122](/images/part2/p2e122.png)

#### 1.3 Опросить интерфейс и убедиться, что изменение применилось

Давайте еще раз взглянем на описание интерфейса через API, которое мы использовали на первом этапе:
![p2e131](/images/part2/p2e131.png)

Описание интерфейса было изменено на 'Set via Netpalm', как и было задумано.
![p2e132](/images/part2/p2e132.png)

Вот как просто на самом деле изменить некоторые настройки устройства с помощью Netpalm.
Мы могли бы использовать и NAPALM.

### Пример 2: Добавить интерфейс с RESTCONF.

**RESTCONF** в целом является немного более сложным протоколом, поэтому я хотел бы, пользуясь возможностью, привести несколько примеров. Давайте попробуем добавить интерфейс к нашему устройству.

Идём по аналогичному примеру 1 плану:
1. Проверить существующие интерфейсы;
2. Внести изменения на интерфейс;
3. Опросить интерфейс и убедиться, что изменение применилось.

#### 2.1 Проверка существующих интерфейсов

Сначала проверим, какие интерфейсы в настоящее время есть на нашем устройстве. Для этого мы будем использовать RESTCONF для получения информации. На самом деле, это именно то, что мы узнали в примере использования 4 из первой части. Мы могли бы также легко использовать для этого Netmiko или NAPALM, но мы уже видели это в примере 1 выше.

![p2e211](/images/part2/p2e211.png)

Используя метод `task`, смотрим вывод `show int desc` и `show ip int br`.
![p2e212](/images/part2/p2e212.png)

Кроме того, мы можем проверить интерфейсы, используя старый добрый CLI.
Я вошел в устройство через SSH, чтобы получить список.

```
csr1000v-1#show ip interface brief
Interface              IP-Address      OK? Method Status                Protocol
GigabitEthernet1       10.10.20.48     YES other  up                    up
GigabitEthernet2       10.255.255.2    YES other  administratively down down
GigabitEthernet3       10.255.255.2    YES other  up                    up
```

#### 2.2 Вносим изменения на интерфейс

Давайте добавим дополнительный интерфейс (BDI100). В NetPalm есть API для этого, смотрите его [тут](https://documenter.getpostman.com/view/2391814/SzYbxcQx?version=latest#68da9960-7c95-4045-8a28-15becdb2b104).

В примере ниже видно, что мы вызываем `setconfig` и передаем в теле JSON довольно много информации:

1. URI: соответствует URI для работы с интерфейсами на нашем IOS XE устройстве.
2. payload: информация, необходимая для создания интерфейса на устройстве.

**Примечание**: делал это раньше в примере 6 [этого сообщения](https://blog.wimwauters.com/networkprogrammability/2020-04-03_restconf_introduction_part2/).

Ниже приведен снимок экрана, на котором мы добавляем (POST) интерфейс к нашему устройству.
![p2e221](/images/part2/p2e221.png)

На скриншоте ниже мы в основном получаем обратно HTTP статус, код 201 из REST API, который является кодом ответа, указывающим на то, что что-то было создано успешно на нашем устройстве.
![p2e222](/images/part2/p2e222.png)

#### 2.3 Опросить интерфейс и убедиться, что изменение применилось

Посмотрим, успешно ли добавлен интерфейс. Мы просто войдём в устройство по SSH.
Как видно из приведённого ниже фрагмента, интерфейс `BDI100` был успешно добавлен в устройство.

```
csr1000v-1#show ip interface brief
Interface              IP-Address      OK? Method Status                Protocol
GigabitEthernet1       10.10.20.48     YES other  up                    up
GigabitEthernet2       10.255.255.2    YES other  administratively down down
GigabitEthernet3       10.255.255.2    YES other  up                    up
BDI100                 unassigned      YES unset  down                  down
csr1000v-1#show interface description
Interface                      Status         Protocol Description
Gi1                            up             up       MANAGEMENT INTERFACE - DON'T TOUCH ME
Gi2                            admin down     down     Configured by RESTCONF
Gi3                            up             up       Configured by RESTCONF
BD100                          down           down     Interface added through NetPalm
```

### Пример 3: Изменение интерфейса с RESTCONF.

Изменение интерфейса работает очень похожим образом. В основном мы хотим изменить описание созданного интерфейса (BDI100). Давайте изменим описание с 'Interface added through NetPalm' на что-то вроде 'Interface changed through NetPalm'.

Картинка ниже иллюстрирует сие действие. 
Обратите внимание на действие `PATCH`, которое указывает на то, что мы хотим обновить конфигурацию.

![p2e311](/images/part2/p2e311.png)

Получаем `"status": "success"`, указывающее на то, что `PATCH` отработал успешно.
![p2e312](/images/part2/p2e312.png)

Проверяем через SSH:
```
csr1000v-1#show interface description
Interface                      Status         Protocol Description
Gi1                            up             up       MANAGEMENT INTERFACE - DON'T TOUCH ME
Gi2                            admin down     down     Configured by RESTCONF
Gi3                            up             up       Configured by RESTCONF
BD100                          down           down     Interface changed through NetPalm
```

Уверен, что описание нашего интерфейса было изменено :-)

### Пример 4: Удалить интерфейс с RESTCONF.

Теперь давайте удалим интерфейс, который только добавили. Для этого мы будем использовать [этот](https://documenter.getpostman.com/view/2391814/SzYbxcQx?version=latest#f7c75846-aace-4bc4-ab58-2ec34054b4e6) API.

На скриншоте ниже вы заметите, что я указываю URI на точный интерфейс, который мы хотим удалить, и мы добавляем метод 'delete'.
![p2e411](/images/part2/p2e411.png)

В ответ вы получите статус, в котором упоминается, что действие прошло успешно. См. снимок экрана ниже.
![p2e412](/images/part2/p2e412.png)

Далее мы еще раз запустим метод `getconfig` Netmiko для проверки списка интерфейсов. 
Опять же, как уже упоминалось пару раз, мы могли бы просто использовать SSH для проверки этого, или NAPALM, или Netmiko, или RESTCONF напрямую....
![p2e413](/images/part2/p2e413.png)

И, как мы и ожидали, интерфейс BDI100 удален из нашего устройства и, следовательно, не отображается в списке интерфейсов.
![p2e414](/images/part2/p2e414.png)

